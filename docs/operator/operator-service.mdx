---
title: Operator Service
sidebar_position: 11
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';
import useBaseUrl from '@docusaurus/useBaseUrl';

# Operator Service

## What is the Operator Service?

The Operator Service is a software developed by StakeWise, designed to run seamlessly alongside any node setup, allowing operators to run their preferred execution and consensus clients, MEV relay, and distributed validator technology.

It is responsible for performing the following tasks:

### Validator Registration

The Operator Service periodically checks whether the Vault has accumulated enough assets for registering new validator(s) and sends a registration transaction to the Vault.

The Operator Service supports registering both `0x01` and `0x02` validators within the same Vault using the `--validators-type` flag to specify the validator type (e.g., `--validators-type=v1`). By default, the Operator Service registers new `0x02` validators, prioritizing funding existing compound validators when possible; otherwise, it registers new validators up to the maximum balance (2048 ETH or 64 GNO) via the `register_new_validators` function.
Transactions are executed through the `fund_validators` and `register_validators` functions.

:::custom-notes[Top Up Only `0x02` Compound Validators]
  Funding is disabled for `0x01` validator type.
:::

The registration process follows a structured sequence of steps to ensure secure validator deployment:

:::custom-notes[Validator Registration Process]

1. Check if the Vault has enough assets to register a validator (e.g., 32 ETH for Ethereum)
2. Get the next free validator key from the used keystore
3. Obtain the BLS signature for exit messages<sup><a href="#user-content-fn-1" id="user-content-fnref-1" style={{textDecoration: 'none'}}>1</a></sup> using local keystores or a [remote signer →](./alternative-key-creation/remote-signer)
4. Share the validator's exit signature with StakeWise Oracles:
    - Split the BLS signature<sup><a href="#user-content-fn-2" id="user-content-fnref-2" style={{textDecoration: 'none'}}>2</a></sup> using [Shamir's Secret Sharing ↗](https://en.wikipedia.org/wiki/Shamir%27s_secret_sharing) (number of shares = number of oracles)
    - Encrypt each signature share with the corresponding oracle’s public key
    - Send the encrypted shares to all oracles and receive registration signatures in return
5. Submit a transaction to the Vault contract to register the validator.
:::

The Operator Service automatically generates deposit data during registration, eliminating the need for pre-uploaded deposit data files.

For details on how Oracles approve validator registration requests, see the *Oracles*: [*Validator Registration Approval* →](../docs/protocol-concepts/Oracles#validator-registration-approval) section.

### Exit Signatures Rotation

The Operator Service maintains validator exit capabilities by monitoring oracle set changes and updating signatures when needed, ensuring validators can always be exited even if oracle keys are compromised.
Without rotation, compromised or outdated oracle keys could prevent validator exits.

### Vault State Update (Optional Feature)

Updating the Vault state distributes fees, updates staker positions, and reprices Vault-specific ERC-20 tokens based on rewards and penalties.

#### How It Works

By default, each Vault state updates when users interact with the Vault (deposit, withdraw, etc.) with a 12-hour cooldown.
When enabled with the `--harvest-vault` flag, the Operator Service automatically distributes Vault fees to the fee address and updates each staker's position every 12 hours, with gas fees paid by the wallet linked to the Operator Service.

:::custom-tips[Benefits of Vault Harvesting]
  Harvesting Vault rewards simplifies contract calls and reduces gas fees.
:::

### Partial Withdrawals

The Operator Service automatically processes validator withdrawals.
Partial withdrawals run every 24 hours by default, processing balances above 32 ETH or 1 GNO, prioritizing higher balances first.
If capacity is insufficient or no validators exceed the threshold, the service triggers full exits via execution requests.
If the Operator Service does not initiate withdrawals, [Oracles →](../../docs/protocol-concepts/Oracles) automatically execute full exits after 24 hours.

#### Configuration Options

- **Disable Partial Withdrawals**: Use `--disable-withdrawals` parameter to rely on oracle-managed full validator exits instead
- **Withdrawal Interval**: Configurable via `PARTIAL_WITHDRAWALS_INTERVAL` environment variable (default: 24h)

:::custom-warning[Performance Impact]
  Disabling partial withdrawals forces the system to use oracle-managed validator exits, which may negatively impact the Vault's APR due to longer processing times.
:::

### Multi-Vault Support

The Operator Service can manage multiple Vaults simultaneously using a single wallet and shared keystores.
All validator keys are shared across connected Vaults using the `--vaults` flag with comma-separated addresses (e.g., `--vaults=0x1...23,0x4...56`).

:::custom-tips[Migration to Multi-Vault Setup]
  When migrating from a single-vault to a multi-vault setup, recreate your operator directory. This ensures your configuration aligns correctly with the new setup.
:::

### Validators Consolidation

Consolidates legacy `0x01` validators to `0x02` compound validators using the `consolidate` command, enabling variable validator balances up to 2048 ETH. This reduces validator count and infrastructure overhead.
The Operator Service includes a `check_vault_version` function to ensure compatibility with Pectra-enabled Vaults only. The consolidation process requires oracle signatures, which are automatically fetched during the operation.

:::custom-warning[Validators Manager Required]
  The wallet executing this command must be set as the Validators Manager in the Vault settings.
:::


Optionally specify `--source-public-keys` (`0x01` validators) and `--target-public-key` (`0x02` validators) parameters to consolidate selected validators.

```bash
./operator consolidate --vault=0x000...  --source-public-keys=0x001,0x002 --target-public-key=0x003
```

Follow the prompts to complete consolidation:

<details className="custom-details">
<summary>Example Consolidation Process</summary>

```
Enter the comma separated list of API endpoints for execution nodes: https://example.com
Enter the comma separated list of API endpoints for consensus nodes: https://example.com
Enter your vault address: 0x3320ad928c20187602a2b2c04eeaa813fa899468
Enter the network name (mainnet, hoodi, gnosis, chiado) [mainnet]: hoodi
Found 15 legacy validators eligible for consolidation
Target consolidation: 7 compound validators (14 legacy validators + 1 remaining)
Continue with consolidation? [y/N]: y
```

</details>

Read more about [Validators consolidations ↗](https://github.com/stakewise/v3-operator/tree/v4?tab=readme-ov-file#validators-consolidation)

### Automated Reward Splitting

Enables periodic withdrawal of rewards for Vault fee shareholders based on their configured percentages.
The periodic withdrawal task relies on the `Reward Splitter` contract and combines multiple contract calls into a single multicall:

1. **Harvest Vault rewards** from [Keeper contract ↗](https://etherscan.io/address/0x6B5815467da09DaA7DC83Db21c9239d98Bb487b5#code)
2. **Withdraw Splitter rewards** on behalf of each shareholder (rewards go to exit queue)
3. **Claim exited assets** on behalf of each shareholder (assets go directly to shareholder address)

:::custom-warning[Fee Claimer Required]
  Set the wallet address connected to the Operator Service as the `Fee Claimer` in the `Roles` tab under the Vault's Settings.
:::

You must pass the `--claim-fee-splitter` flag when starting the Operator Service:

```bash
./operator start-local --claim-fee-splitter --vaults=0x3320a...68
```

#### Configuration Options

- **Distribution Interval**: Configurable via `REWARD_SPLITTER_INTERVAL` environment variable (default: 24h)
- **Minimum Threshold**: Set via `REWARD_SPLITTER_MIN_ASSETS` environment variable to avoid gas-inefficient small transactions (value specified in Wei)

### Validators Voluntary Exit

Validator exits are handled by [Oracles →](../../docs/protocol-concepts/Oracles), but you can force trigger exits for your validators using the `exit-validators` command. The command now supports validator exits via the withdrawal queue, with exits triggered through `submit_withdraw_validators`.

```bash
./operator exit-validators
```

Follow the prompts to confirm your consensus and execution node endpoints, Vault address, and validator indexes to exit. Use the optional `--indexes` parameter to exit only selected validators.

<details className="custom-details">
<summary>Example Output</summary>

```
Enter the comma separated list of API endpoints for execution nodes: : https://example.com
Enter the comma separated list of API endpoints for consensus nodes: https://example.com
Enter your vault address: 0x3320ad928c20187602a2b2c04eeaa813fa899468
Are you sure you want to exit 3 validators with indexes: 513571, 513572, 513861? [y/N]: y
Validators 513571, 513572, 513861 exits successfully initiated
```
</details>

## Next Steps

Before running the Operator Service, you must first ensure your infrastructure meets the necessary [Prerequisites →](./prerequisites) outlined in the next section.


## Recover Validator Keystores

You can recover validator keystores that are active. The recovery process will detect validators associated with your Vault address.

:::custom-warning[Safety Requirements]
  Before recovering keystores:
  - **Stop all validators** - Ensure no validators are running with these keystores
  - **Wait at least 2 epochs** - Allow time to pass to avoid slashing
  - **Protect mnemonic** - Your seed phrase can generate all validator keys
:::

```bash
./operator recover
```

<details className="custom-details">
<summary>Example Output</summary>
```
Enter the mnemonic for generating the validator keys: [Your Mnemonic Here]
Enter your vault address: 0x3320ad928c20187602a2b2c04eeaa813fa899468
Enter the comma separated list of API endpoints for execution nodes: https://example.com
Enter the comma separated list of API endpoints for consensus nodes: https://example.com
Enter the network name: hoodi
Found 24 validators, recovering...
Generating keystores [####################################] 100%
Keystores for vault 0x3320ad928c20187602a2b2c04eeaa813fa899468 successfully recovered to /home/user/.stakewise/keystores
```
</details>

## Advanced Configuration

### Environment Variables

Operator Service can be configured via environment variables instead of CLI flags.
Copy [this example file ↗](https://github.com/stakewise/v3-operator/blob/master/.env.example) and save it as `.env`.

```bash
# Load environment variables
export $(grep -v '^#' .env | xargs)

# Verify they're loaded
env
```

### Gas Fee Limits

Protect against excessive gas costs by setting maximum fees:

```bash
./operator start --max-fee-per-gas-wei=100000000000  # 100 Gwei max
```

### CPU Optimization

Reduce CPU load during key operations:

```bash
# Use half your CPU cores (recommended)
./operator create-keys --pool-size=2
```
:::custom-tips[Performance Tip]
  Setting `--pool-size` to half your CPU cores ensures smooth node operation during keystore operations.
:::







<div id="user-content-fn-1" style={{fontSize: '0.85em', color: '#6b7280', marginTop: '2rem', listStyle: 'none', fontFamily: 'Fragment Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace'}}>
  <span>1.</span>
  Validators in Ethereum use two sets of BLS keys: <strong>validator keys (hot)</strong> and <strong>withdrawal keys (cold)</strong>. Validator keys sign attestations, blocks, and exits (`SignedVoluntaryExit`), while withdrawal keys secure the eventual withdrawal of stake and rewards.
  <a href="#user-content-fnref-1" style={{color: '#6b7280', textDecoration: 'none'}}>↩</a>
</div>

<div id="user-content-fn-2" style={{fontSize: '0.85em', color: '#6b7280', marginTop: '2rem', listStyle: 'none', fontFamily: 'Fragment Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace'}}>
  <span>2.</span>
  BLS (Boneh–Lynn–Shacham) is a digital signature scheme introduced in 2001. It relies on the hardness of the <a href="https://www.iacr.org/archive/asiacrypt2001/22480516.pdf" style={{textDecoration: 'underline', color: '#018970'}}>Computational Diffie–Hellman (CDH) problem</a> to prevent forgery. A user selects a secret key and derives the corresponding public key on an elliptic curve. To sign, the message is hashed to a curve point and multiplied by the secret key, producing the signature. Verification uses a bilinear pairing to confirm validity. Learn more about BLS signatures <a href="https://www.iacr.org/archive/asiacrypt2001/22480516.pdf" style={{textDecoration: 'underline', color: '#018970'}}>here</a>.
  <a href="#user-content-fnref-2" style={{color: '#6b7280', textDecoration: 'none'}}>↩</a>
</div>
