---
title: Operator Service
sidebar_position: 2
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';
import useBaseUrl from '@docusaurus/useBaseUrl';

# Operator Service

## What is the Operator Service?

The Operator Service is a software developed by the Stakewise team, designed to run seamlessly alongside any node setup, giving operators the freedom to run their preferred execution and consensus clients, MEV relay, and distributed validator technology.

It is responsible for performing the following tasks:

### Validator Registration

The Operator Service periodically checks whether Vault has accumulated enough assets for registering new validator(s) and sends a registration transaction to the Vault.

The Operator Service supports registering both `0x01` and `0x02` validators within the same Vault using the `--validators-type` flag to specify the validator type (e.g., `--validators-type=v1`). By default, the operator registers new `0x02` validators, prioritizing funding of existing compound validators when possible; otherwise, it registers new validators up to the maximum balance (2048 ETH or 64 GNO) via the `register_new_validators` function.
Transactions are executed through the `fund_validators` and `register_validators` functions.

<Admonition type="tip" icon={<img src={useBaseUrl('/img/asterisk.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Top up only compound (0x02) validators">
  Note that funding is disabled for `0x01` validator type
</Admonition>

The registration process follows a structured sequence of steps to ensure secure validator deployment:

<Admonition type="note" icon={<img src={useBaseUrl('/img/safe.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Validator Registration Process">
  <ol style={{ listStyleType: "none", paddingLeft: "0" }}>
    <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>1.</span> Check whether Vault has accumulated enough assets to register a validator (e.g., 32 ETH for Ethereum)</li>
    <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>2.</span> Get the next free validator key from the used keystore</li>
    <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>3.</span> Obtain BLS signature for exit message<sup><a href="#user-content-fn-1" id="user-content-fnref-1" style={{textDecoration: 'none'}}>1</a></sup> using local keystores or remote signer</li>
    <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>4.</span> Share the exit signature of the validator with StakeWise Oracles:</li>
    <ul style={{ listStyleType: "disc", paddingLeft: "80px" }}>
      <li>Using Shamir's secret sharing, splits validator's BLS signature<sup><a href="#user-content-fn-2" id="user-content-fnref-2" style={{textDecoration: 'none'}}>2</a></sup>. The number of shares equals the number of oracles</li>
      <li>Encrypts exit signatures with the oracles' public keys</li>
      <li>Sends encrypted exit signatures to all the oracles and receives registration signatures from them</li>
    </ul>
    <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>5.</span> Sends transaction to the Vault contract to register the validator.</li>
  </ol>
</Admonition>

The Operator Service automatically generates deposit data during registration, eliminating the need for pre-uploaded deposit data files.

For details on how Oracles approve validator registration requests, see the *Oracles*: [*Validator Registration Approval* →](../docs/protocol-concepts/Oracles#validator-registration-approval) section.

### Exit Signatures Rotation

The Operator Service maintains validator exit capabilities by monitoring oracle set changes and updating signatures when needed, ensuring validators can always be exited even if oracle keys are compromised.

### Vault State Update (Optional)

Updating the Vault state distributes fees, updates staker positions, and reprices Vault-specific ERC-20 tokens based on rewards and penalties.

#### How It Works

By default, each Vault state updates when users interact with the Vault (deposit, withdraw, etc.) with a 12-hour cooldown.
When enabled with the `--harvest-vault` flag, the Operator Service automatically distributes Vault fees to the fee address and updates each staker's position every 12 hours, with gas fees paid by the wallet linked to the Operator Service.

<Admonition type="tip" icon={<img src={useBaseUrl('/img/asterisk.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Benefits of Vault Harvesting">
  Harvesting the Vault rewards simplifies the contract calls to the Vault contract and reduces the gas fees for stakers. For example, the Vault does not need to sync rewards before calling deposit when a user stakes.
</Admonition>

### Partial Withdrawals

The Operator Service automatically processes partial ETH/GNO withdrawals from validators. Partial withdrawals run every 24 hours by default, processing available ETH from validators with balances exceeding 32 ETH or 1 GNO, prioritizing validators with higher balances first.
If partial withdrawal capacity is insufficient or no validators have balances above the threshold, the Operator Service triggers full validator exits via execution request calls.
If the operator does not initiate partial or full withdrawals, [Oracles →](../../docs/protocol-concepts/Oracles) automatically execute full withdrawal after 24 hours.

#### Configuration Options

- **Disable Partial Withdrawals**: Use `--disable-withdrawals` parameter to rely on oracle-managed full validator exits instead
- **Withdrawal Interval**: Configurable via `PARTIAL_WITHDRAWALS_INTERVAL` environment variable (default: 24h)

<Admonition type="warning" icon={<img src={useBaseUrl('/img/exclamation_mark.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Performance Impact">
  Disabling partial withdrawals forces the system to use oracle-managed validator exits, which may negatively impact the Vault's APR due to longer processing times.
</Admonition>

### Multi-Vault Support

The Operator Service can manage multiple Vaults simultaneously using a single wallet and shared keystores.
All validator keys are shared across connected Vaults using the `--vaults` flag with comma-separated addresses (e.g., `--vaults=0x1...23,0x4...56`).

<Admonition type="warning" icon={<img src={useBaseUrl('/img/exclamation_mark.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Migration to Multi-Vault Setup">
  When migrating from single-vault to multi-vault configuration, recreate your operator directory for a clean migration. This ensures proper configuration alignment with the new multi-vault setup.
</Admonition>

### Validators Consolidation

Consolidates legacy `0x01` validators to `0x02` compound validators using the `consolidate` command, enabling variable validator balances up to 2048 ETH. This reduces the total validator count and lowers infrastructure overhead.
The Operator Service includes a `check_vault_version` function to ensure compatibility with Pectra-enabled Vaults only. The consolidation process requires oracle signatures, which are automatically fetched during the operation.

<Admonition type="warning" icon={<img src={useBaseUrl('/img/exclamation_mark.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Validators Manager Required">
  The wallet executing this command must be set as the Validators Manager in the Vault settings.
</Admonition>


Optionally specify `--source-public-keys` (`0x01` validators) and `--target-public-key` (`0x02` validators) parameters to consolidate selected validators.

```bash
./operator consolidate --vault=0x000...  --source-public-keys=0x001,0x002 --target-public-key=0x003
```

Follow the interactive prompts to specify your consolidation preferences:

<details className="custom-details">
<summary>Example Consolidation Process</summary>

```
Enter the comma separated list of API endpoints for execution nodes: https://example.com
Enter the comma separated list of API endpoints for consensus nodes: https://example.com
Enter your vault address: 0x3320ad928c20187602a2b2c04eeaa813fa899468
Enter the network name (mainnet, hoodi, gnosis, chiado) [mainnet]: hoodi
Found 15 legacy validators eligible for consolidation
Target consolidation: 7 compound validators (14 legacy validators + 1 remaining)
Continue with consolidation? [y/N]: y
```

</details>

Read more about [Validators consolidations ↗](https://github.com/stakewise/v3-operator/tree/v4?tab=readme-ov-file#validators-consolidation)

### Automated Reward Splitting

Enables periodic withdrawal of rewards for Vault fee shareholders based on their configured percentages.
The periodic withdrawal task relies on the `Reward Splitter` contract and combines multiple contract calls into a single multicall:

<ol style={{ listStyleType: "none", paddingLeft: "0" }}>
  <li><span style={{ display: "inline-block", width: "2ch", textAlign: "left" }}>1.</span> **Harvest Vault rewards** from [Keeper contract ↗](https://etherscan.io/address/0x6B5815467da09DaA7DC83Db21c9239d98Bb487b5#code)</li>
  <li><span style={{ display: "inline-block", width: "2ch", textAlign: "left" }}>2.</span> **Withdraw Splitter rewards** on behalf of each shareholder (rewards go to exit queue)</li>
  <li><span style={{ display: "inline-block", width: "2ch", textAlign: "left" }}>3.</span> **Claim exited assets** on behalf of each shareholder (assets go directly to shareholder address)</li>
</ol>

<Admonition type="warning" icon={<img src={useBaseUrl('/img/exclamation_mark.png')} alt="Warning" style={{ width: 20, height: 20 }}/>} title="Fee Claimer Required">
  Set the wallet address connected to the Operator Service as the `Fee Claimer` in the `Roles` tab under the Vault's Settings.
</Admonition>

You must pass the `--claim-fee-splitter` flag when starting the Operator Service:

```bash
./operator start-local --claim-fee-splitter --vaults=0x3320a...68
```

#### Configuration Options

<ol style={{ listStyleType: "none", paddingLeft: "0" }}>
  <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>•</span> **Distribution Interval**: Configurable via `REWARD_SPLITTER_INTERVAL` environment variable (default: 24h)</li>
  <li><span style={{ display: "inline-block", width: "3ch", textAlign: "left" }}>•</span> **Minimum Threshold**: Set via `REWARD_SPLITTER_MIN_ASSETS` environment variable to avoid gas-inefficient small transactions (value specified in Wei)</li>
</ol>

### Validators Voluntary Exit

Validator exits are handled by [Oracles →](../../docs/protocol-concepts/Oracles), but you can force trigger exits for your validators using the `exit-validators` command. The command now supports validator exits via the withdrawal queue, with exits triggered through `submit_withdraw_validators`.

```bash
./operator exit-validators
```

Follow the prompts to confirm your consensus and execution node endpoints, Vault address, and validator indexes to exit. Use the optional `--indexes` parameter to exit only selected validators.

<details className="custom-details">
<summary>Example Output</summary>

```
Enter the comma separated list of API endpoints for execution nodes: : https://example.com
Enter the comma separated list of API endpoints for consensus nodes: https://example.com
Enter your vault address: 0x3320ad928c20187602a2b2c04eeaa813fa899468
Are you sure you want to exit 3 validators with indexes: 513571, 513572, 513861? [y/N]: y
Validators 513571, 513572, 513861 exits successfully initiated
```
</details>

## Next Steps

To run the Operator Service effectively, you must first ensure your infrastructure meets the necessary [Prerequisites →](./prerequisites) outlined in the next section.

<div id="user-content-fn-1" style={{fontSize: '0.85em', color: '#6b7280', marginTop: '2rem', listStyle: 'none', fontFamily: 'Fragment Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace'}}>
  <span>1.</span>
  Validators in Ethereum use two sets of BLS keys: <strong>validator keys (hot)</strong> and <strong>withdrawal keys (cold)</strong>. Validator keys sign attestations, blocks, and exits (`SignedVoluntaryExit`), while withdrawal keys secure the eventual withdrawal of stake and rewards.
  <a href="#user-content-fnref-1" style={{color: '#6b7280', textDecoration: 'none'}}>↩</a>
</div>

<div id="user-content-fn-2" style={{fontSize: '0.85em', color: '#6b7280', marginTop: '2rem', listStyle: 'none', fontFamily: 'Fragment Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace'}}>
  <span>2.</span>
  BLS (Boneh–Lynn–Shacham) is a digital signature scheme introduced in 2001. It relies on the hardness of the <a href="https://www.iacr.org/archive/asiacrypt2001/22480516.pdf" style={{textDecoration: 'underline', color: '#018970'}}>Computational Diffie–Hellman (CDH) problem</a> to prevent forgery. A user selects a secret key and derives the corresponding public key on an elliptic curve. To sign, the message is hashed to a curve point and multiplied by the secret key, producing the signature. Verification uses a bilinear pairing to confirm validity. Learn more about BLS signatures <a href="https://www.iacr.org/archive/asiacrypt2001/22480516.pdf" style={{textDecoration: 'underline', color: '#018970'}}>here</a>.
  <a href="#user-content-fnref-2" style={{color: '#6b7280', textDecoration: 'none'}}>↩</a>
</div>
